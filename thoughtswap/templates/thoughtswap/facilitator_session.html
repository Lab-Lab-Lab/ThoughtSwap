<h2>Facilitator</h2>

<textarea id="promptText" placeholder="Write a prompt..."></textarea>
<button onclick="sendPrompt()">Send Prompt</button>
<button onclick="sendSwap()">Swap Responses</button>


<hr>

<div id="promptList">
    {% for group in session_data %}
    <div class="prompt-block" data-puid="{{ group.prompt_use_id }}">
        <strong>{{ group.prompt }}</strong>
        <ul class="response-list">
            {% for response in group.thoughts %}
            <li>{{ response }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endfor %}
</div>

<script>
    const socket = new WebSocket("ws://" + window.location.host + "/ws/thoughtswap/{{ course.join_code }}/");

    socket.onmessage = function (e) {
        console.log("Full WebSocket message (raw):", e.data);

        const data = JSON.parse(e.data);
        console.log("WebSocket message received:", data);

        if (data.type === "new_thought") {
            const promptId = data.prompt_id;
            const content = data.content;

            const block = document.querySelector(`.prompt-block[data-puid='${promptId}']`);
            if (block) {
                const ul = block.querySelector(".response-list");
                const el = document.createElement("li");
                el.innerText = content;
                ul.appendChild(el);
            } else {
                console.warn("No prompt block found for prompt_id:", promptId);
            }
        }


        if (data.type === "new_prompt") {
            const existing = document.querySelector(`.prompt-block[data-puid='${data.prompt_id}']`);
            if (existing) {
                console.log("Prompt already exists, skipping append for:", data, data.prompt_id);
                return;
            }
            else {
                console.log("Appending new prompt:", data.prompt_id);
            }


            const promptList = document.getElementById("promptList");

            const block = document.createElement("div");
            block.className = "prompt-block";
            block.dataset.puid = data.prompt_id;

            const strong = document.createElement("strong");
            strong.innerText = data.content;
            block.appendChild(strong);

            const ul = document.createElement("ul");
            ul.className = "response-list";
            block.appendChild(ul);

            promptList.insertBefore(block, promptList.firstChild);
        }

    };

    function sendPrompt() {
        const content = document.getElementById("promptText").value;
        if (content.trim() === "") return;

        socket.send(JSON.stringify({
            type: "disperse_prompt",
            content: content
        }));
        document.getElementById("promptText").value = "";
    }

    function sendSwap() {
            socket.send(JSON.stringify({
                type: "swap_responses"
            }));
        }

</script>